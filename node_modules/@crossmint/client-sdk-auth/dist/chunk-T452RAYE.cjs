"use strict";Object.defineProperty(exports, "__esModule", {value: true});var _chunkNZ2DAY24cjs = require('./chunk-NZ2DAY24.cjs');var _chunkVDJHVTKIcjs = require('./chunk-VDJHVTKI.cjs');var _chunkTEI6NKFCcjs = require('./chunk-TEI6NKFC.cjs');var _chunkCK4JCQY6cjs = require('./chunk-CK4JCQY6.cjs');var _commonsdkauth = require('@crossmint/common-sdk-auth');var _clientsdkbase = require('@crossmint/client-sdk-base');var p=!1,C= exports.a =class P extends _commonsdkauth.CrossmintAuth{constructor(a,t,e={}){var r,s,i;super(a,t,e);this.refreshTask=null;this.refreshPromise=null;this.callbacks=(r=e.callbacks)!=null?r:{},this.logoutRoute=(s=e.logoutRoute)!=null?s:null,this.storageProvider=(i=e.storageProvider)!=null?i:_chunkTEI6NKFCcjs.b.call(void 0, )}static from(a,t={}){let e=new P(a,_commonsdkauth.CrossmintAuth.defaultApiClient(a),t);return typeof window!="undefined"&&(p||(p=!0,setTimeout(()=>{e.handleRefreshAuthMaterial().catch(r=>{console.debug("Initial auth refresh failed:",r)}).finally(()=>{p=!1})},0))),e}getUser(){return _chunkCK4JCQY6cjs.c.call(void 0, this,null,function*(){var a;try{let t=yield this.apiClient.get(`api/${_commonsdkauth.CROSSMINT_API_VERSION}/sdk/auth/user`,{headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error((a=JSON.parse(yield t.text()))==null?void 0:a.message);return yield t.json()}catch(t){throw new (0, _commonsdkauth.CrossmintAuthenticationError)(`Failed to fetch user: ${t instanceof Error?t.message:"Unknown error"}`)}})}storeAuthMaterial(a){return _chunkCK4JCQY6cjs.c.call(void 0, this,null,function*(){let t=_chunkVDJHVTKIcjs.a.call(void 0, a.jwt);if(t==null)throw new Error("Invalid JWT");let e=new Date(t*1e3).toISOString();yield Promise.all([this.storageProvider.set(_commonsdkauth.SESSION_PREFIX,a.jwt,e),this.storageProvider.set(_commonsdkauth.REFRESH_TOKEN_PREFIX,a.refreshToken.secret,a.refreshToken.expiresAt)])})}logout(){return _chunkCK4JCQY6cjs.c.call(void 0, this,null,function*(){var t,e;let a=yield this.storageProvider.get(_commonsdkauth.REFRESH_TOKEN_PREFIX);yield Promise.all([this.storageProvider.remove(_commonsdkauth.REFRESH_TOKEN_PREFIX),this.storageProvider.remove(_commonsdkauth.SESSION_PREFIX)]),(e=(t=this.callbacks).onLogout)==null||e.call(t);try{this.logoutRoute!=null?yield this.logoutFromCustomRoute():a!=null&&(yield this.logoutFromDefaultRoute(a))}catch(r){console.error(r)}})}handleRefreshAuthMaterial(a){return _chunkCK4JCQY6cjs.c.call(void 0, this,null,function*(){var t,e;try{let r=a!=null?a:yield this.storageProvider.get(_commonsdkauth.REFRESH_TOKEN_PREFIX);if(r==null&&this.refreshRoute==null)return yield this.logout(),null;this.refreshPromise==null&&(this.refreshPromise=this.refreshAuthMaterial(r));let s=yield this.refreshPromise;return this.refreshRoute==null&&(yield this.storeAuthMaterial(s)),(e=(t=this.callbacks).onTokenRefresh)==null||e.call(t,s),this.scheduleNextRefresh(s.jwt),s}catch(r){return console.error(r),yield this.logout(),null}finally{this.refreshPromise=null}})}getOAuthUrl(a,t){return _chunkCK4JCQY6cjs.c.call(void 0, this,null,function*(){var e;try{let r=new URLSearchParams;(t==null?void 0:t.appSchema)!=null&&r.set("appSchema",t.appSchema);let s=r.toString(),i=`${_commonsdkauth.AUTH_SDK_ROOT_ENDPOINT}/social/${a}/start${s?`?${s}`:""}`,h=yield this.apiClient.get(i,{headers:{"Content-Type":"application/json"}});if(!h.ok)throw new Error((e=JSON.parse(yield h.text()))==null?void 0:e.message);return(yield h.json()).oauthUrl}catch(r){if(console.error(`Failed to get OAuth URL for provider ${a}: ${r instanceof Error?r.message:"Unknown error"}`),r instanceof Error&&r.message.includes("Request from origin")){let s=r.message.match(/origin "([^"]+)"/),i=s==null?void 0:s[1];if(i)throw new (0, _commonsdkauth.CrossmintAuthenticationError)(`Unauthorized origin: ${i}. Please add this origin to your API key's authorized origins in the Crossmint Console.`)}throw new (0, _commonsdkauth.CrossmintAuthenticationError)("Unable to load oauth providers. Please try again later.")}})}sendEmailOtp(a){return _chunkCK4JCQY6cjs.c.call(void 0, this,null,function*(){var t;try{let e=yield this.apiClient.post(`${_commonsdkauth.AUTH_SDK_ROOT_ENDPOINT}/otps/send`,{headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a})});if(!e.ok)throw new Error((t=JSON.parse(yield e.text()))==null?void 0:t.message);return yield e.json()}catch(e){throw new (0, _commonsdkauth.CrossmintAuthenticationError)(`Failed to send email OTP: ${e instanceof Error?e.message:"Unknown error"}`)}})}confirmEmailOtp(a,t,e){return _chunkCK4JCQY6cjs.c.call(void 0, this,null,function*(){var r;try{let s=new URLSearchParams({email:a,signinAuthenticationMethod:"email",token:e,locale:"en",state:t,callbackUrl:`${this.apiClient.baseUrl}/${_commonsdkauth.AUTH_SDK_ROOT_ENDPOINT}/callback`}),i=yield this.apiClient.post(`${_commonsdkauth.AUTH_SDK_ROOT_ENDPOINT}/authenticate?${s}`,{headers:{"Content-Type":"application/json"}});if(!i.ok)throw new Error((r=JSON.parse(yield i.text()))==null?void 0:r.message);return(yield i.json()).oneTimeSecret}catch(s){throw new (0, _commonsdkauth.CrossmintAuthenticationError)(`Failed to confirm email OTP: ${s instanceof Error?s.message:"Unknown error"}`)}})}signInWithFarcaster(a){return _chunkCK4JCQY6cjs.c.call(void 0, this,null,function*(){var t;try{let e=new URLSearchParams({signinAuthenticationMethod:"farcaster",callbackUrl:`${this.apiClient.baseUrl}/${_commonsdkauth.AUTH_SDK_ROOT_ENDPOINT}/callback`}),r=yield this.apiClient.post(`${_commonsdkauth.AUTH_SDK_ROOT_ENDPOINT}/authenticate?${e}`,{headers:{"Content-Type":"application/json"},body:JSON.stringify(_chunkCK4JCQY6cjs.b.call(void 0, _chunkCK4JCQY6cjs.a.call(void 0, {},a),{domain:a.signatureParams.domain,redirect:!0,callbackUrl:`${this.apiClient.baseUrl}/${_commonsdkauth.AUTH_SDK_ROOT_ENDPOINT}/callback`}))});if(!r.ok)throw new Error((t=JSON.parse(yield r.text()))==null?void 0:t.message);return(yield r.json()).oneTimeSecret}catch(e){throw new (0, _commonsdkauth.CrossmintAuthenticationError)(`Failed to sign in with Farcaster: ${e instanceof Error?e.message:"Unknown error"}`)}})}signInWithSmartWallet(a,t){return _chunkCK4JCQY6cjs.c.call(void 0, this,null,function*(){var e;try{let r=t==="evm"?"ethereum":"solana",s=yield this.apiClient.post(`${_commonsdkauth.AUTH_SDK_ROOT_ENDPOINT}/crypto_wallets/authenticate/start`,{headers:{"Content-Type":"application/json"},body:JSON.stringify({walletAddress:a,walletType:r})});if(!s.ok)throw new Error((e=JSON.parse(yield s.text()))==null?void 0:e.message);return yield s.json()}catch(r){throw new (0, _commonsdkauth.CrossmintAuthenticationError)(`Failed to initiate smart wallet sign in: ${r instanceof Error?r.message:"Unknown error"}`)}})}authenticateSmartWallet(a,t,e){return _chunkCK4JCQY6cjs.c.call(void 0, this,null,function*(){var r;try{let s=new URLSearchParams({signinAuthenticationMethod:t,callbackUrl:`${this.apiClient.baseUrl}/${_commonsdkauth.AUTH_SDK_ROOT_ENDPOINT}/callback`}),i=yield this.apiClient.post(`${_commonsdkauth.AUTH_SDK_ROOT_ENDPOINT}/crypto_wallets/authenticate?${s}`,{headers:{"Content-Type":"application/json"},body:JSON.stringify({walletAddress:a,signature:e})});if(!i.ok)throw new Error((r=JSON.parse(yield i.text()))==null?void 0:r.message);return yield i.json()}catch(s){throw new (0, _commonsdkauth.CrossmintAuthenticationError)(`Failed to authenticate smart wallet: ${s instanceof Error?s.message:"Unknown error"}`)}})}logoutFromCustomRoute(){return _chunkCK4JCQY6cjs.c.call(void 0, this,null,function*(){if(!this.logoutRoute)throw new Error("Custom logout route is not set");return yield fetch(this.logoutRoute,{method:"POST"})})}scheduleNextRefresh(a){let t=_chunkVDJHVTKIcjs.a.call(void 0, a);if(t==null)throw new Error("Invalid JWT");let e=Date.now()/1e3,r=t-e-120;if(r>0){let s=Date.now()+r*1e3;this.cancelScheduledRefresh(),this.refreshTask=_clientsdkbase.queueTask.call(void 0, ()=>this.handleRefreshAuthMaterial(),s)}}cancelScheduledRefresh(){this.refreshTask&&(this.refreshTask.cancel(),this.refreshTask=null)}};exports.a = C;
